define(["jquery","assets/common/base64","event"],function(JQuery,Base64,ajaxConfig){var base64=new Base64,store=function(){function isLocalStorageNameSupported(){try{return localStorageName in win&&win[localStorageName]}catch(err){return!1}}function isGlobalStorageNameSupported(){try{return globalStorageName in win&&win[globalStorageName]&&win[globalStorageName][win.location.hostname]}catch(err){return!1}}function withIEStorage(storeFunction){return function(){var args=Array.prototype.slice.call(arguments,0);args.unshift(storage);doc.body.appendChild(storage);storage.addBehavior("#default#userData");storage.load(localStorageName);var result=storeFunction.apply(api,args);doc.body.removeChild(storage);return result}}var storage,api={},win=window,doc=win.document,localStorageName="localStorage",globalStorageName="globalStorage";api.disabled=!1;api.set=function(key,value){};api.get=function(key){};api.remove=function(key){};api.clear=function(){};api.transact=function(key,transactionFn){var val=api.get(key);"undefined"==typeof val&&(val={});transactionFn(val);api.set(key,val)};api.serialize=function(value){return JSON.stringify(value)};api.deserialize=function(value){if("string"==typeof value)return JSON.parse(value)};if(isLocalStorageNameSupported()){storage=win[localStorageName];api.set=function(key,val){storage.setItem(key,api.serialize(val))};api.get=function(key){return api.deserialize(storage.getItem(key))};api.remove=function(key){storage.removeItem(key)};api.clear=function(){storage.clear()}}else if(isGlobalStorageNameSupported()){storage=win[globalStorageName][win.location.hostname];api.set=function(key,val){storage[key]=api.serialize(val)};api.get=function(key){return api.deserialize(storage[key]&&storage[key].value)};api.remove=function(key){delete storage[key]};api.clear=function(){for(var key in storage)delete storage[key]}}else if(doc.documentElement.addBehavior){var storage=doc.createElement("div");api.set=withIEStorage(function(storage,key,val){storage.setAttribute(key,api.serialize(val));storage.save(localStorageName)});api.get=withIEStorage(function(storage,key){return api.deserialize(storage.getAttribute(key))});api.remove=withIEStorage(function(storage,key){storage.removeAttribute(key);storage.save(localStorageName)});api.clear=withIEStorage(function(storage){var attributes=storage.XMLDocument.documentElement.attributes;storage.load(localStorageName);for(var attr,i=0;attr=attributes[i];i++)storage.removeAttribute(attr.name);storage.save(localStorageName)})}else api.disabled=!0;return api}(),_ajaxBase=function(url,type,cmd,dataType,callback,sync){var cache="html"==dataType;$.ajax({"url":url,"type":type,"data":cmd,"cache":cache,"dataType":dataType,"async":!sync,"timeout":config.TIME_OUT,"beforeSend":function(xhr){xhr.overrideMimeType("text/plain; charset=utf-8")},"success":function(data){if(data)if("html"!=dataType){try{if("BUSIOPER=RELOGIN"==data.returnCode){window.location.href="../../login.html";return}}catch(e){alert("JSON Format Error:"+e.toString())}if(callback&&data){var isSuc=data.returnCode==config.reqCode.SUCC;callback(data||{},isSuc)}}else callback(data,!0)},"error":function(e){var retErr={};retErr["returnCode"]="404";retErr["returnMessage"]="网络异常或超时，请稍候再试！";callback(retErr,!1)},"complete":function(){}})},_ajaxJsonp=function(url,type,cmd,callback,sync){if(!url||""===url){console.log("the url of param cann't equals null or empty of string");return!1}if(!callback||""===callback){console.log("you missed callback, it must be a function");return!1}cmd&&""!==cmd||console.log("warn! your passed null or empty to cmd param, are you suer?");$.ajax({"url":url,"type":type,"data":cmd,"jsonpCallback":"jsonCallback","contentType":"application/json","dataType":"jsonp","async":!sync,"timeout":config.TIME_OUT,"beforeSend":function(xhr){xhr.overrideMimeType("text/plain; charset=utf-8")},"success":function(data){if(data){try{if("BUSIOPER=RELOGIN"==data.returnCode){window.location.href="../../login.html";return}}catch(e){alert("JSON Format Error:"+e.toString())}if(callback&&data){var isSuc=data.returnCode==config.reqCode.SUCC;callback(data||{},isSuc)}}},"error":function(){var retErr={};retErr["returnCode"]="404";retErr["returnMessage"]="网络异常或超时，请稍候再试！";callback(retErr,!1)},"complete":function(){}})},config={"reqCode":{"SUCC":0},"errorUrl":"http://frontlogger.cs.cmos/frontlogger/log/","userId":"-","projectCode":"-","dataType":{"HTML":"html","JSON":"json","TEXT":"text"},"TIME_OUT":6e4,"SHOW_SUCC_INFO":!1,"SHOW_ERROR_INFO":!1},ajax={"getJson":function(url,cmd,callback,sync){if(sync&&"boolean"==typeof sync)sync=sync;else if(callback){if("function"==typeof callback)callback=callback;else if("boolean"==typeof callback){sync=callback;callback=""}}else if(cmd){if("object"==typeof cmd||"string"==typeof cmd)cmd=cmd;else if("function"==typeof cmd){callback=cmd;cmd=""}else if("boolean"==typeof cmd){sync=cmd;cmd="";callback=""}}else{cmd="";callback="";sync=""}sync?_ajaxBase(url,"GET",cmd,config.dataType.JSON,callback,!0):_ajaxBase(url,"GET",cmd,config.dataType.JSON,callback)},"postJson":function(url,cmd,callback,sync){if(sync&&"boolean"==typeof sync)sync=sync;else if(callback){if("function"==typeof callback)callback=callback;else if("boolean"==typeof callback){sync=callback;callback=""}}else if(cmd){if("object"==typeof cmd||"string"==typeof cmd)cmd=cmd;else if("function"==typeof cmd){callback=cmd;cmd=""}else if("boolean"==typeof cmd){sync=cmd;cmd="";callback=""}}else{cmd="";callback="";sync=""}sync?_ajaxBase(url,"POST",cmd,config.dataType.JSON,callback,!0):_ajaxBase(url,"POST",cmd,config.dataType.JSON,callback)},"uuidFast":function(){for(var r,CHARS="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),chars=CHARS,uuid=new Array(36),rnd=0,i=0;i<36;i++)if(8==i||13==i||18==i||23==i)uuid[i]="-";else if(14==i)uuid[i]="4";else{rnd<=2&&(rnd=33554432+16777216*Math.random()|0);r=15&rnd;rnd>>=4;uuid[i]=chars[19==i?3&r|8:r]}return uuid.join("")},"putJson":function(url,cmd,callback,sync){if(sync&&"boolean"==typeof sync)sync=sync;else if(callback){if("function"==typeof callback)callback=callback;else if("boolean"==typeof callback){sync=callback;callback=""}}else if(cmd){if("object"==typeof cmd||"string"==typeof cmd)cmd=cmd;else if("function"==typeof cmd){callback=cmd;cmd=""}else if("boolean"==typeof cmd){sync=cmd;cmd="";callback=""}}else{cmd="";callback="";sync=""}sync?_ajaxBase(url,"PUT",cmd,config.dataType.JSON,callback,!0):_ajaxBase(url,"PUT",cmd,config.dataType.JSON,callback)},"deleteJson":function(url,cmd,callback,sync){if(sync&&"boolean"==typeof sync)sync=sync;else if(callback){if("function"==typeof callback)callback=callback;else if("boolean"==typeof callback){sync=callback;callback=""}}else if(cmd){if("object"==typeof cmd||"string"==typeof cmd)cmd=cmd;else if("function"==typeof cmd){callback=cmd;cmd=""}else if("boolean"==typeof cmd){sync=cmd;cmd="";callback=""}}else{cmd="";callback="";sync=""}sync?_ajaxBase(url,"DELETE",cmd,config.dataType.JSON,callback,!0):_ajaxBase(url,"DELETE",cmd,config.dataType.JSON,callback)},"getJsonp":function(url,cmd,callback,sync){_ajaxJsonp(url,"GET",cmd,callback,sync)},"ajax":function(options){var config=$.extend({"type":"post","dataType":"json","timeout":3e4,"beforeSend":function(xhr){xhr.overrideMimeType("text/plain; charset=utf-8")}},options);$.ajax(config)},"cors":function(options){$.support&&($.support.cors=!0);var config=$.extend({"type":"post","dataType":"json","crossDomain":!0,"timeout":config.TIME_OUT,"contentType":"application/json; charset=utf-8","beforeSend":function(xhr){xhr.overrideMimeType("text/plain; charset=utf-8")}},options);$.support&&$.support.msie&&(config["xhrFields"]={"withCredentials":!0});$.ajax(config)},"setUserId":function(id){id&&(config.userId=id)},"setProjectCode":function(projectCode){projectCode&&(config.projectCode=projectCode)},"getTime":function(){var time=new Date,m=time.getMonth()+1;return[time.getFullYear(),m,time.getDate(),time.getHours(),time.getMinutes(),time.getSeconds()].join("")},"sendError":function(msg,url){var _this=this;url!=this.errorUrl?this.getJsonp(config.errorUrl+config.projectCode+"/"+msg.id+"/"+config.userId+"/"+msg.url+"/"+msg.time+"/"+msg.textStatus+"/"+msg.status+"/"+msg.statusText+"/"+msg.responseText+"/"+msg.readyState+"/"+msg.returnCode+"/"+msg.returnMessage,{},function(json,state){if(state){var ajaxError=_this.getItem();ajaxError&&ajaxError[msg.id]&&delete ajaxError[msg.id];_this.setItem(ajaxError?ajaxError:{})}else _this.storageError(msg,url)}):this.storageError(msg,url)},"getItem":function(){return store.get("ajaxError")},"setItem":function(error){store.set("ajaxError",JSON.stringify(error))},"storageError":function(msg,url){this.errorObj=this.errorObj||{};this.errorObj[msg.id]=msg;this.setItem(this.errorObj)},"firstSendError":function(){var ajaxError=this.getItem();for(var i in ajaxError)this.sendError(ajaxError[i])},"start":function(){var _this=this;$(document).ajaxComplete(function(event,jqxhr,settings){var uuid;uuid=settings.headers&&settings.headers.ReqId?settings.headers.ReqId:_this.uuidFast();if(jqxhr.responseText){var responseText=JSON.parse(jqxhr.responseText);"0"!=responseText.returnCode&&_this.sendError({"id":uuid,"url":base64.encode(settings.url),"time":_this.getTime(),"textStatus":base64.encode(jqxhr.error.name?jqxhr.error.name:"-"),"status":base64.encode((jqxhr.status?jqxhr.status:"-")+""),"statusText":base64.encode(jqxhr.statusText?jqxhr.statusText:"-"),"responseText":base64.encode("-"),"readyState":base64.encode((jqxhr.readyState?jqxhr.readyState:"-")+""),"returnCode":base64.encode(responseText.returnCode?responseText.returnCode:"-"),"returnMessage":base64.encode(responseText.returnMessage?responseText.returnMessage:"-")},settings.url)}else _this.sendError({"id":uuid,"url":base64.encode(settings.url),"time":_this.getTime(),"textStatus":base64.encode(jqxhr.error.name?jqxhr.error.name:"-"),"status":base64.encode((jqxhr.status?jqxhr.status:"-")+""),"statusText":base64.encode(jqxhr.statusText?jqxhr.statusText:"-"),"responseText":base64.encode(jqxhr.responseText?jqxhr.responseText:"-"),"readyState":base64.encode(jqxhr.readyState?jqxhr.readyState:"-"),"returnCode":"-","returnMessage":"-"},settings.url)});this.firstSendError()}};ajaxConfig.ajaxAbnormalStart&&ajax.start();return ajax});